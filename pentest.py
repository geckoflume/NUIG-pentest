#!/usr/bin/env python3
# coding=utf-8
from os import makedirs, listdir, path, remove
from os.path import dirname, realpath
from shutil import copyfile

from tests import *
from tools import leds
from tools.aircrack import Aircrack
from tools.aireplay import Aireplay
from tools.airmon import Airmon
from tools.airodump import Airodump
from tools.config import Config
from tools.pandoc import Pandoc

logo = """
             ███▄    █  █    ██  ██▓  ▄████                  
             ██ ▀█   █  ██  ▓██▒▓██▒ ██▒ ▀█▒                 
            ▓██  ▀█ ██▒▓██  ▒██░▒██▒▒██░▄▄▄░                 
            ▓██▒  ▐▌██▒▓▓█  ░██░░██░░▓█  ██▓                 
            ▒██░   ▓██░▒▒█████▓ ░██░░▒▓███▀▒                 
            ░ ▒░   ▒ ▒ ░▒▓▒ ▒ ▒ ░▓   ░▒   ▒                  
            ░ ░░   ░ ▒░░░▒░ ░ ░  ▒ ░  ░   ░                  
               ░   ░ ░  ░░░ ░ ░  ▒ ░░ ░   ░                  
                     ░    ░      ░        ░                  
 ██▓███  ▓█████  ███▄    █ ▄▄▄█████▓▓█████   ██████ ▄▄▄█████▓
▓██░  ██▒▓█   ▀  ██ ▀█   █ ▓  ██▒ ▓▒▓█   ▀ ▒██    ▒ ▓  ██▒ ▓▒
▓██░ ██▓▒▒███   ▓██  ▀█ ██▒▒ ▓██░ ▒░▒███   ░ ▓██▄   ▒ ▓██░ ▒░
▒██▄█▓▒ ▒▒▓█  ▄ ▓██▒  ▐▌██▒░ ▓██▓ ░ ▒▓█  ▄   ▒   ██▒░ ▓██▓ ░ 
▒██▒ ░  ░░▒████▒▒██░   ▓██░  ▒██▒ ░ ░▒████▒▒██████▒▒  ▒██▒ ░ 
▒▓▒░ ░  ░░░ ▒░ ░░ ▒░   ▒ ▒   ▒ ░░   ░░ ▒░ ░▒ ▒▓▒ ▒ ░  ▒ ░░   
░▒ ░      ░ ░  ░░ ░░   ░ ▒░    ░     ░ ░  ░░ ░▒  ░ ░    ░    
░░          ░      ░   ░ ░   ░         ░   ░  ░  ░    ░      
            ░  ░         ░             ░  ░      ░           
"""


def _setup():
    leds.led_mode("green", "heartbeat")
    print(logo)
    Config("config.ini")
    Test.interface.check()
    Test.airmon = Airmon()
    Test.aircrack = Aircrack()
    Test.airodump = Airodump()
    Test.aireplay = Aireplay()
    try:
        makedirs(Test.results_path)
        makedirs(Test.tmp_path)
    except FileExistsError:
        pass
    if Test.interface.exists:
        Ip()
    else:
        print("Interface " + Test.interface.name + " does not exist! Is it in monitor mode?")
        _clean()


def _run_all():
    if Test.interface.is_wireless:
        WifiScan()
        HiddenSsid()
        # Wep()
    if Test.interface.has_ip:
        Cdp()
        DynamicRouting()
        Fhrp()
        NbtScan()
        Nmap()
        Ping()
        PublicIp()
        Traceroute()
    else:
        print("No IP address, end of tests!")


def generate_report():
    Pandoc()
    copyfile(dirname(realpath(__file__)) + "/style.css", Test.results_path + "style.css")


def _clean():
    for file in listdir(dirname(realpath(__file__))):
        if "replay_arp" in file and path.isfile(file):
            remove(file)
    leds.led_mode("red", "off")
    leds.led_mode("green", "default-on")
    exit(1)


_setup()
_run_all()
generate_report()
_clean()
