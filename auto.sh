#!/bin/bash

interface="wlan1"

generatereport() {
	pandoc -s --toc --css style.css $path/*.md -o $path/report_$timestamp.html
	if [[ $? = 0 ]]; then
		echo "Report file successfully generated in $path/report_$timestamp.html"
	else
		echo 'Unable to generate report file'
	fi
	cp style.css $path/
} # generatereport

printstatus() {
	if [[ $? = 0 ]]; then
		echo -e "[\033[0;32m  OK  \033[0m] $@"
	else
		echo -e "[\033[0;31mFAILED\033[0m] $@"
	fi
} # printstatus

./switch_led.sh heartbeat

timestamp=$(date +"%Y%m%d_%H%M%S")
path=$(pwd)/results/$timestamp
header=$path/0-header.md
mkdir -p $path
echo "# Pentest $(date +\"%Y%m%d_%H%M%S\")" > $header

if ifconfig $interface &> /dev/null; then #interface exists
		if iwconfig $interface &> /dev/null && [[ -z $(iwconfig $interface | grep 'ESSID:\"') ]]; then #interface is wireless and is not connected
				echo "**Wireless interface $interface is not connected!**" >> $header
				status=1
		else
			# IP Details
			./tests/ip.sh $path $interface
			printstatus "IP Details"

			# ICMP Test
			./tests/ping.sh $path $interface
			printstatus "ICMP Test"

			# Traceroute
			./tests/traceroute.sh $path $interface
			printstatus "Traceroute"

			# CDP Snooping
			./tests/cdp.sh $path $interface
			printstatus "CDP Snooping"

			# FHRP Snooping
			./tests/fhrp.sh $path $interface
			printstatus "FHRP Snooping"

			# Dynamic routing protocol Snooping
			./tests/dynamicrouting.sh $path $interface
			printstatus "Dynamic routing protocol Snooping"

			# NBTScan
			./tests/nbtscan.sh $path $interface
			printstatus "NBTScan"
		fi
else
		echo "**Interface $interface does not exist!**" >> $header
		status=1
fi

generatereport

./switch_led.sh default
exit 0
