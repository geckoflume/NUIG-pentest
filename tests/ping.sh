#!/bin/bash

if [[ $# -ne 1 ]]; then
	echo "Syntax : $0 testname"
	exit 1
fi

./switch_led.sh on
filename=$1/$(basename -- $0 .sh).md

echo '# Verify ICMP connectivity to the Internet' > $filename
echo 'The board will try to ping [www.google.com](http://www.google.com). This will ascertain if the firewall permits ICMP pings to the Internet.' >> $filename
echo >> $filename
echo '## Vulnerability' >> $filename
echo 'If ICMP (ping) traffic is permitted, the user could leverage this "security hole" to launch additional attacks.' >> $filename
echo >> $filename
echo '## Exploit' >> $filename
echo 'The user can send IP traffic hidden inside an ICMP tunnel. The firewall will only see ICMP traffic and the user can launch all kinds of attacks which the firewall has no visibility of.' >> $filename
echo >> $filename
echo '## Countermeasure' >> $filename
echo 'ICMP pings are commonly used to troubleshoot connectivity to the Internet. It is advisable to configure the firewall to ONLY permit ICMP pings from pre-defined devices, for example devices used by the IT team. This facilitates troubleshooting by the IT team, whilst denying everyone else ICMP access to the Internet.' >> $filename
echo >> $filename
echo '## Test results' >> $filename
echo '```' >> $filename
ping -c 4 www.google.com &>> $filename
status=$?
echo '```' >> $filename
if [[ $? = 0 ]]; then
	echo '**Internet connection/ICMP pings are working!**' >> $filename
else
	echo '**Internet connection/ICMP pings are NOT working!**' >> $filename
fi
echo >> $filename
echo '---' >> $filename

./switch_led.sh off
exit $status
