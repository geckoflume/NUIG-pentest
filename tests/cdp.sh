#!/bin/bash

if [[ $# -ne 1 ]]; then
	echo "Syntax : $0 testname"
	exit 1
fi

./switch_led.sh on
filename=$1/$(basename -- $0 .sh).md
interface=wlan1

echo '# CDP (Cisco Discovery Protocol) snooping' > $filename
echo 'The board will listen, capture and display any CDP (Cisco Discovery Protocol) announcements. The test will run for 60 seconds based on the default hello timer for CDP. Please Note: If no CDP messages were received during this interval, there will be no output displayed below.' >> $filename
echo >> $filename
echo '## Vulnerability' >> $filename
echo 'The information contained within CDP announcements leaks important detail relating to the Cisco network devices being deployed. Network devices may include Cisco switches, wireless access-points and routers.' >> $filename
echo >> $filename
echo '## Exploit' >> $filename
echo 'Although there is not a direct exploit for this vulnerability, the user now has possession of very sensitive information relating to the Cisco network devices, such as the hardware model, software version in use, IP addresses being used, etc. Armed with this information, the user can launch attacks. For example, the user can research vulnerabilities relating to the software version advertised by CDP and launch attacks to compromise the network device.' >> $filename
echo >> $filename
echo '## Countermeasure' >> $filename
echo 'CDP is a useful tool, however the default settings leak sensitive information. The best countermeasure for this is to disable CDP on all user facing switch interfaces - in other words CDP is only enabled on interfaces that connect to other network devices such as switch-to-switch uplinks.' >> $filename
echo >> $filename
echo '## Test results' >> $filename
echo '```' >> $filename

#-nn don't do dns or port number lookups
#-vvv very verbose output
#-i $interface specifies the interface to use
#-s 1500 capture 1500 bytes of the packet (typical MTU size)
#ether[20:2] == 0x2000  capture only packets that have a 2 byte value of hex 2000 starting at byte 20
tcpdump -nn -v -i $interface -s 1500 'ether[20:2] == 0x2000' &>> $filename & PID=$!
sleep 60
kill $PID &> /dev/null
wait $PID
status=$?

echo '```' >> $filename
if [[ $status = 0 ]]; then
	echo '**CDP snooping complete!**' >> $filename
else
	echo '**CDP snooping NOT complete!**' >> $filename
fi
echo >> $filename
echo '---' >> $filename

./switch_led.sh off
exit $status

