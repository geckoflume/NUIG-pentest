#!/bin/bash

if [[ $# -ne 2 ]]; then
        echo "Syntax : $0 testname interface"
	exit 1
fi

./switch_led.sh on
filename=$1/$(basename -- $0 .sh).md

echo '# FHRP (First Hop Redundancy Protocol) snooping' > $filename
echo 'The board will listen, capture and display FHRP (First Hop Redundancy Protocol) messages. FHRP’s provide redundancy for the default gateway on a LAN or VLAN. HSRP (Hot Standby Router Protocol) and VRRP (Virtual Router Redundancy Protocol) are commonly used FHRP’s used in enterprises. The test will run for 10 seconds based on the default HSRP and VRRP timers.' >> $filename
echo >> $filename
echo '## Vulnerability' >> $filename
echo 'The presence of FHRPs creates an opportunity for the user to implement FHRP related attacks.' >> $filename
echo >> $filename
echo '## Exploit' >> $filename
echo 'It is possible to setup a VRRP daemon (such as keepalived) that allows to participate in VRRP. Then, it can be configured with a high VRRP priority to ensure it becomes the ‘active’ default gateway on the LAN or VLAN. Once this is achieved, the user can launch a DoS (Denial of Service) attack on the LAN or VLAN by black-holing all traffic or it can perform a MITM (Man In The Middle) attack, whereby all user traffic on the LAN or VLAN is routed across it (the board is the default gateway and see’s all user traffic).' >> $filename
echo >> $filename
echo '## Countermeasure' >> $filename
echo 'The use of FHRP’s is common and considered good practise. To countermeasure this attack, both HSRP and VRRP support an "MD5 Authentication" feature which generates an Message Digest 5 (MD5) digest for the HSRP and VRRP messages. If a FHRP message is received that has not been encrypted with the same authentication key, the message is discarded. Configuring authentication for FHRP messages will prevent the board from implementing this exploit.' >> $filename
echo >> $filename
echo '## Test results' >> $filename
echo '```' >> $filename

#-vvv very verbose output
#-i $2 specifies the interface to use
#proto VRRP or udp port 1985 capture only VRRP or HSRP (port 1985) packets
tcpdump -vvv -i $2 proto VRRP or udp port 1985 &>> $filename & PID=$!
#default hello timer for HSRP and VRRP is 10 seconds so this should capture all announcements
sleep 10
kill $PID &> /dev/null
wait $PID
status=$?

echo '```' >> $filename
if [[ $status = 0 ]]; then
	echo '**FHRP snooping complete!**' >> $filename
else
	echo '**FHRP snooping NOT complete!**' >> $filename
fi
echo >> $filename
echo '---' >> $filename

./switch_led.sh off
exit $status
