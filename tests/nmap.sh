#!/bin/bash

if [[ $# -ne 2 ]]; then
	echo "Syntax : $0 testname interface"
	exit 1
fi

./switch_led.sh on
filename=$1/$(basename -- $0 .sh).md
network=$(ipcalc -nb $(nmcli dev show $2 | grep IP4.ADDRESS | awk '{print $NF}') | grep Network | awk '{print $NF}')

echo '# Nmap hosts and services discovery' > $filename
echo "The board will perform an nmap ‘Quick Scan’ against the boards local subnet ($2) - $network." >> $filename
echo >> $filename
echo '## Vulnerability' >> $filename
echo "This information yields extremely useful information about the users and devices that reside on the same IP subnet as the board ($2 interface)." >> $filename
echo >> $filename
echo '## Exploit' >> $filename
echo 'Although there is not a direct exploit for this vulnerability, the user can use this information to target specific users and/or devices. The user may notice a specific service operating on a device and attempt to compromise that device using a known vulnerability associated with that service. An additional attack vector may include using ARP poisoning against a local server to capture passwords in a classic MITM (Man In The Middle) style attack.' >> $filename
echo >> $filename
echo '## Countermeasure' >> $filename
echo 'The best way to prevent nmap scanning within the internal network is to use using IEEE 802.1x port authentication. An alternative, less desirable, option is to use Private VLANs.' >> $filename
echo >> $filename
echo '## Test results' >> $filename
echo '```' >> $filename

#-F fast mode - scan fewer ports than the default scan
#-T5 timing template (higher is faster)
#-Pn treat all hosts as online -- skip host discovery
#-sS TCP SYN scan
#-O enable OS detection
#--osscan-limit limit OS detection to promising targets (if at least one open and one closed TCP port are found)
nmap $network -F -T5 -Pn -sS -O --osscan-limit >> $filename
status=$?

echo '```' >> $filename
if [[ $status = 0 ]]; then
	echo '**Nmap scan complete!**' >> $filename
else
	echo '**Nmap scan NOT complete!**' >> $filename
fi
echo >> $filename
echo '---' >> $filename

./switch_led.sh off
exit $status

