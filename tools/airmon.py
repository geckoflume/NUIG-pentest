#!/usr/bin/env python3
import time
from subprocess import run, TimeoutExpired, DEVNULL

from tests import Test


class Airmon:
    def _airmon(self, mode, channel=False):
        try:
            if channel:
                proc = run(["airmon-ng", mode, Test.interface.name, channel], stdout=DEVNULL, stderr=DEVNULL,
                           timeout=10)
            else:
                proc = run(["airmon-ng", mode, Test.interface.name], stdout=DEVNULL, stderr=DEVNULL, timeout=10)
        except TimeoutExpired as e:
            time.sleep(2)
            return 1
        else:
            time.sleep(2)
            return proc.returncode

    def monitor(self, channel=False):
        if Test.interface.wlan_mode is 'station':
            r = self._airmon("start", channel)
            Test.interface.name += 'mon'  # to add the "mon" at the end of the interface
            Test.interface.wlan_mode = 'monitor'
            return r
        return 1

    def station(self):
        if Test.interface.wlan_mode is 'monitor':
            r = self._airmon("stop")
            Test.interface.name = Test.interface.name[:-3]  # to remove the "mon" at the end of the interface
            Test.interface.wlan_mode = 'station'
            return r
        return 1
