#!/usr/bin/env python3

from subprocess import run, TimeoutExpired, DEVNULL, PIPE

from tests import Test, Airodump
from tools.config import Config


class Wash:
    def __init__(self):
        self.raw = ''

    def parse_scan(self):
        skip_next = False
        for line in self.raw.splitlines():
            if 'BSSID' in line:
                skip_next = True
                continue
            if skip_next:
                skip_next = False
                continue
            for t in Airodump.targets:
                if t.bssid == line[:17]:
                    t.wps = line[29:32].strip()
                    t.wps_lock = line[34:37].strip()
                    t.nic_vendor = line[38:47].strip()

    def scan(self):
        try:
            proc = run([Config.wash_bin, "-i", Test.interface.name, "-a"], stdout=PIPE, stderr=DEVNULL,
                       timeout=Config.wash_scan_duration)
        except TimeoutExpired as e:
            self.raw = e.stdout.decode()
            self.parse_scan()
            return 0
